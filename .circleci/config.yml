version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@2.0.0

executors:
  pythonpygame:
    docker:
      - image: feralbert90/pokepong1:latest  # Dockerfile que se necesita de dockerhub

jobs:
  job-tests:
    executor: pythonpygame
    steps:
      - checkout  # Para obtener el código del repositorio
      # Aquí agregamos los pasos para ejecutar tests, linting, análisis estático, etc.
      - run:
          name: Run tests
          command: | 
                    pytest Game/tests
      - run:
          name: Run linting
          command: | 
                    pylint  --exit-zero Game
      - run:
          name: Run code coverage
          command: |
                    coverage run -m pytest Game
                    coverage report -m 
      - store_test_results:
          path: Game/tests/test-results.xml
      - sonarcloud/scan

  job-deployment:
    executor: pythonpygame
    steps:
      - checkout
      - run:
          name: Set up GH_TOKEN
          command: |
            echo 'export GH_TOKEN=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e' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Install gh
          command: |
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            apt-get update
            apt-get install gh -y
      - run:
          name: Package artifact
          command: |
            mkdir -p artifacts
            tar -czvf artifacts/myapp.tar.gz Game/*
      
      - run:
          name: Upload artifact to GitHub Releases
          command: |
            gh release create v1.0.0 artifacts/myapp.tar.gz

workflows:
  workflow-testing:
    jobs:
      - job-tests:
          context: SonarCloud
      - job-deployment:
          requires:
            - job-tests
          filters:
            branches:
              only: main
      # Agrega un trabajo para desplegar en Kubernetes usando ArgoCD
      # Este trabajo solo se ejecutará en la rama master/mainn
